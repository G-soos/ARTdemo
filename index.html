<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ART - An√°lisis de Riesgos de la Tarea</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- html2pdf + html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root{ --bg:#f7f7f9; --accent-red:#ef4444; --accent-blue:#0f4b8f; --accent-teal:#0d9488; }
    body{ font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:#0f172a; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }

    /* PDF A4 container used off-screen (stable, avoids blank pages) */
    #pdf-render-target{ width:794px; min-height:1123px; box-sizing:border-box; background:#fff; padding:28px; }

    /* Page and PDF visuals (preview) */
    .pdf-page{ width:794px; min-height:1123px; background:#fff; margin:0 auto; padding:28px; box-sizing:border-box; color:#111827; font-size:13px; }

    /* Form */
    .field { display:block; width:100%; }
    .time-row{ display:grid; grid-template-columns:1fr 1fr; gap:1.5rem; }
    @media(min-width:1024px){ .time-row{ gap:2rem; } }

    /* Buttons yes/no selected state */
    .btn-selected{ box-shadow:0 0 0 3px rgba(15,75,143,0.09) inset; transform:translateY(-1px); }
    .btn-selected.dark{ background:#0f4b8f !important; color:#fff !important; border-color:transparent !important; }

    /* radios custom look */
    .answer-btn { padding:.5rem 1rem; border-radius:.5rem; border:1px solid #d1d5db; cursor:pointer; user-select:none; display:inline-flex; align-items:center; gap:.5rem; }
    .answer-btn input { display:none; }

    /* Signature prompt */
    .sig-hint{ display:flex; align-items:center; gap:8px; justify-content:center; padding:10px; border-radius:8px; border:2px dashed #94a3b8; background:#f8fafc; color:#475569; cursor:pointer; }

    /* Modal */
    .modal { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(2,6,23,0.6); z-index:60; }
    .modal-inner { background:#fff; border-radius:12px; padding:18px; width:calc(100% - 40px); max-width:920px; max-height:94vh; overflow:auto; }

    /* mobile download button visible only on small screens */
    #mobile-download-btn{ display:none; }
    @media(max-width:767px){ #mobile-download-btn{ display:inline-block; } }

    /* small helper */
    .hidden { display:none !important; }

    /* wizard */
    .wizard-step{ display:none; }
    .wizard-step.active{ display:block; }
  </style>
</head>
<body class="min-h-screen">

  <div class="max-w-4xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-2xl font-bold text-gray-800">ART ‚Äî An√°lisis de Riesgos de la Tarea</h1>
      <p class="text-sm text-gray-500">Formulario ‚Äî Preview y generaci√≥n de PDF.</p>
    </header>

    <!-- MAIN FORM (Desktop view shows full; mobile shows wizard) -->
    <main id="form-area" class="bg-white rounded-lg shadow p-4">
      <!-- Section: Antecedentes -->
      <section id="etapa1" class="mb-4">
        <h2 class="font-semibold text-lg text-red-600 mb-3">I) ETAPA 1 ‚Äî ANTECEDENTES</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <input id="empresa" class="field p-3 border rounded" placeholder="NOMBRE DE LA EMPRESA" type="text" />
          <input id="supervisor" class="field p-3 border rounded" placeholder="NOMBRE DEL SUPERVISOR" type="text" />
          <input id="area" class="field p-3 border rounded" placeholder="√ÅREA DE TRABAJO" type="text" />
          <input id="lugar_especifico" class="field p-3 border rounded" placeholder="LUGAR ESPEC√çFICO" type="text" />

          <div>
            <label class="block text-sm font-semibold mb-1">FECHA</label>
            <input id="fecha" type="date" class="p-3 border rounded w-full" />
          </div>

          <div>
            <label class="block text-sm font-semibold mb-1">HORARIO</label>
            <div class="time-row">
              <div>
                <label class="text-xs text-gray-500">Hora inicio</label>
                <input id="hora_inicio" type="time" class="p-3 border rounded w-full" />
              </div>
              <div>
                <label class="text-xs text-gray-500">Hora t√©rmino</label>
                <input id="hora_termino" type="time" class="p-3 border rounded w-full" />
              </div>
            </div>
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-semibold mb-1">DESCRIPCI√ìN</label>
            <textarea id="descripcion" rows="3" class="p-3 border rounded w-full" placeholder="DESCRIPCI√ìN DE LA TAREA"></textarea>
          </div>

          <div class="md:col-span-2">
            <label class="block text-sm font-semibold mb-1">FIRMA</label>
            <div id="signature-prompt" class="sig-hint" role="button" tabindex="0" onclick="openSignatureModal();" onkeydown="if(event.key==='Enter') openSignatureModal();">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26M21 8l-7.89 5.26M3 16l7.89-5.26M21 16l-7.89-5.26"/></svg>
              <span id="signature-prompt-text">Toca para firmar ‚Äî (m√≥vil: gira a horizontal)</span>
            </div>
            <input type="hidden" id="firma_base64" />
            <div id="signature-preview" class="mt-2 hidden"><img id="signature-thumb" src="" alt="Firma" style="max-width:260px; border:1px solid #ddd; border-radius:6px;" /></div>
          </div>
        </div>
      </section>

      <!-- Section: 1.2 (Trabajadores) -->
      <section id="etapa1-2" class="mb-4">
        <h3 class="font-semibold text-red-600 mb-2">1.2) DE LOS TRABAJADORES: CONTESTE CADA PREGUNTA</h3>

        <div class="space-y-3" id="check-list-1-2">
          <div class="flex items-center justify-between" data-key="condiciones_fisicas">
            <div>1. ¬øMe encuentro en condiciones f√≠sicas y psicol√≥gicas para realizar la tarea?</div>
            <div class="flex gap-2">
              <label class="answer-btn" data-group="q12_1"><input name="q12_1" type="radio" value="si" /> S√≠</label>
              <label class="answer-btn" data-group="q12_1"><input name="q12_1" type="radio" value="no" /> No</label>
            </div>
          </div>

          <div class="flex items-center justify-between" data-key="condiciones_entorno">
            <div>2. ¬øLas condiciones del entorno permiten realizar mi trabajo de manera segura?</div>
            <div class="flex gap-2">
              <label class="answer-btn" data-group="q12_2"><input name="q12_2" type="radio" value="si" /> S√≠</label>
              <label class="answer-btn" data-group="q12_2"><input name="q12_2" type="radio" value="no" /> No</label>
            </div>
          </div>

          <div class="flex items-center justify-between" data-key="areas_condiciones">
            <div>3. ¬øVerifiqu√© que las √°reas de desplazamiento y trabajo se encuentran en condiciones?</div>
            <div class="flex gap-2">
              <label class="answer-btn" data-group="q12_3"><input name="q12_3" type="radio" value="si" /> S√≠</label>
              <label class="answer-btn" data-group="q12_3"><input name="q12_3" type="radio" value="no" /> No</label>
            </div>
          </div>
        </div>
      </section>

      <!-- Section: 1.3 (Tarea) -->
      <section id="etapa1-3" class="mb-4">
        <h3 class="font-semibold text-blue-600 mb-2">1.3) DE LA TAREA: CONTESTE CADA PREGUNTA</h3>

        <div class="space-y-3" id="check-list-1-3">
          <div data-key="capacitado_prevencion">
            <div>1. ¬øEstoy capacitado(a) y conozco las medidas de prevenci√≥n definidas?</div>
            <div class="flex gap-2 mt-2">
              <label class="answer-btn" data-group="q13_cap"><input name="q13_cap" type="radio" value="si" /> S√≠</label>
              <label class="answer-btn" data-group="q13_cap"><input name="q13_cap" type="radio" value="no" /> No</label>
            </div>
            <p class="text-xs text-red-600 mt-2">UN "NO" EN ESTA PREGUNTA SIGNIFICA <strong>NO INICIAR LA TAREA</strong></p>
          </div>

          <div data-key="documento_regula" class="mt-3">
            <div>2. ¬øExiste alg√∫n documento que regule mi trabajo o tarea?</div>
            <div class="flex gap-2 mt-2">
              <label class="answer-btn" data-group="q13"><input name="q13" type="radio" value="si" onchange="toggleQ13()" /> S√≠</label>
              <label class="answer-btn" data-group="q13"><input name="q13" type="radio" value="no" onchange="toggleQ13()" /> No</label>
            </div>
            <div id="q13_box" class="hidden mt-2">
              <textarea id="q13_text" rows="2" class="p-2 border rounded w-full" placeholder="Indique: manual, instructivo, procedimiento..."></textarea>
            </div>
          </div>

          <div data-key="alcance_actividades" class="mt-3">
            <div>3. ¬øEl documento incluye todas las actividades (alcance) a desarrollar en terreno?</div>
            <div class="flex gap-2 mt-2">
              <label class="answer-btn" data-group="q13_alc"><input name="q13_alc" type="radio" value="si" /> S√≠</label>
              <label class="answer-btn" data-group="q13_alc"><input name="q13_alc" type="radio" value="no" /> No</label>
            </div>
          </div>
        </div>
      </section>

      <!-- Section: Estrategias -->
      <section id="etapa1-4" class="mb-4">
        <h3 class="font-semibold text-teal-700 mb-2">1.4) Estrategias de Control (marque las que apliquen)</h3>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
          <label class="p-3 border rounded flex items-center justify-between gap-2"><span>Aislamiento</span><input type="checkbox" data-strategy-name="Aislamiento" class="strategy-checkbox" /></label>
          <label class="p-3 border rounded flex items-center justify-between gap-2"><span>Se√±alizaci√≥n</span><input type="checkbox" data-strategy-name="Se√±alizaci√≥n" class="strategy-checkbox" /></label>
          <label class="p-3 border rounded flex items-center justify-between gap-2"><span>Permiso de Trabajo</span><input type="checkbox" data-strategy-name="Permiso de Trabajo" class="strategy-checkbox" /></label>
          <label class="p-3 border rounded flex items-center justify-between gap-2"><span>Uso de EPP</span><input type="checkbox" data-strategy-name="EPP" class="strategy-checkbox" /></label>
        </div>
      </section>

      <!-- Actions -->
      <div class="mt-6 flex items-center justify-between">
        <div class="text-sm text-gray-500">ID Local: <span id="user-id" class="font-mono">--</span></div>
        <div class="flex items-center gap-3">
          <button id="preview-art-btn" class="bg-blue-600 text-white px-4 py-2 rounded">Previsualizar</button>
          <button id="load-history-btn" class="bg-gray-200 px-3 py-2 rounded">Historial</button>
        </div>
      </div>
    </main>

    <p class="text-sm text-gray-500 mt-4">En m√≥vil: preview = imagen del PDF; firma en modal horizontal para mejorar la experiencia.</p>
  </div>

  <!-- OFF-SCREEN PDF CONTAINER (stable) -->
  <div id="pdf-render-target" style="position:fixed; left:-9999px; top:0; visibility:hidden;"></div>

  <!-- SIGNATURE MODAL (fullscreen-ish) -->
  <div id="signature-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-inner">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-lg font-bold">Firma digital (supervisor)</h2>
        <button onclick="closeSignatureModal()" class="px-3 py-1 rounded bg-gray-200">Cerrar</button>
      </div>
      <p class="text-sm text-gray-600 mb-3">Si est√°s en m√≥vil, gira el dispositivo a horizontal para firmar con m√°s espacio.</p>

      <div style="display:flex; justify-content:center; align-items:center;">
        <canvas id="signature-canvas" width="1200" height="420" style="max-width:100%; border:2px dashed #cbd5e1; border-radius:8px; touch-action:none;"></canvas>
      </div>

      <div class="flex gap-3 mt-4">
        <button onclick="clearSignatureCanvas()" class="px-4 py-2 bg-yellow-500 rounded text-white">Borrar</button>
        <button onclick="saveSignature();" class="px-4 py-2 bg-blue-600 rounded text-white">Guardar y cerrar</button>
      </div>
    </div>
  </div>

  <!-- PREVIEW MODAL (used for web html preview or mobile image preview) -->
  <div id="pdf-preview-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-inner" style="max-width:900px;">
      <div id="pdf-preview-content" class="mb-4"></div>

      <div class="flex gap-3">
        <input id="pdf-filename-input" type="text" placeholder="Nombre archivo (opcional)" class="p-2 border rounded w-full" />
        <button id="download-pdf-btn" class="bg-blue-600 text-white px-4 py-2 rounded">üì• Descargar PDF</button>
        <button onclick="closePreviewModal()" class="bg-gray-200 px-4 py-2 rounded">Cerrar</button>
      </div>

      <!-- big mobile download button area (visible on mobile) -->
      <div class="mt-4 hidden md:block" id="mobile-download-area-placeholder"></div>
      <div style="margin-top:10px;">
        <button id="mobile-download-btn" class="w-full bg-green-600 text-white py-3 rounded-lg hidden">üì• Descargar PDF</button>
      </div>
    </div>
  </div>

  <!-- HISTORY modal (minimal) -->
  <div id="history-modal" class="modal hidden" aria-hidden="true">
    <div class="modal-inner">
      <div class="flex justify-between items-center mb-2">
        <h3 class="text-lg font-bold">Historial local</h3>
        <button onclick="closeHistoryModal()" class="px-2 py-1 rounded bg-gray-100">Cerrar</button>
      </div>
      <div id="history-list"></div>
      <p class="text-sm text-gray-500 mt-3">Los chequeos se guardan localmente en tu navegador.</p>
    </div>
  </div>

<script>
/* ------------------------ INIT & HELPERS ------------------------ */
let userId = 'Local-' + Math.random().toString(16).slice(2,8);
document.getElementById('user-id').textContent = userId;

function isMobile(){ return window.innerWidth < 768; }
function $(id){ return document.getElementById(id); }

/* ------------------------ Signature canvas ------------------------ */
let sigCanvas = $('signature-canvas');
let sigCtx = sigCanvas.getContext('2d');
let drawing = false;
let lastX = 0, lastY = 0;

function initSignatureCanvas(){
  sigCanvas = $('signature-canvas');
  if(!sigCanvas) return;
  sigCtx = sigCanvas.getContext('2d');
  // set line width depending on canvas width
  const base = Math.max(2, Math.round(sigCanvas.width / 400));
  sigCtx.lineWidth = base * 2;
  sigCtx.lineJoin = 'round';
  sigCtx.lineCap = 'round';
  sigCtx.strokeStyle = '#111827';

  // pointer events (unified)
  sigCanvas.addEventListener('pointerdown', startSig);
  sigCanvas.addEventListener('pointermove', moveSig);
  sigCanvas.addEventListener('pointerup', endSig);
  sigCanvas.addEventListener('pointercancel', endSig);
  sigCanvas.style.touchAction = 'none';
}

function startSig(e){
  e.preventDefault();
  drawing = true;
  const rect = sigCanvas.getBoundingClientRect();
  lastX = e.clientX - rect.left;
  lastY = e.clientY - rect.top;
  sigCtx.beginPath();
  sigCtx.moveTo(lastX, lastY);
}
function moveSig(e){
  if(!drawing) return;
  e.preventDefault();
  const rect = sigCanvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  sigCtx.lineTo(x, y);
  sigCtx.stroke();
  lastX = x; lastY = y;
}
function endSig(e){
  drawing = false;
}

function clearSignatureCanvas(){
  if(!sigCtx) return;
  sigCtx.clearRect(0,0,sigCanvas.width, sigCanvas.height);
}

function openSignatureModal(){
  // enlarge canvas for mobile horizontally if possible
  const modal = $('signature-modal');
  modal.classList.remove('hidden');
  // try to resize canvas for mobile: make it wider if device width > height
  setTimeout(()=>{
    if(window.innerWidth < 768){
      // prefer landscape-like area
      const w = Math.max(window.innerWidth, window.innerHeight) - 40;
      const h = Math.floor(window.innerHeight * 0.55);
      sigCanvas.width = Math.max(900, Math.floor(w));
      sigCanvas.height = Math.max(240, Math.floor(h));
    } else {
      sigCanvas.width = 1200;
      sigCanvas.height = 420;
    }
    // reset drawing context scaled to new size
    initSignatureCanvas();
  }, 50);
}

function closeSignatureModal(){
  $('signature-modal').classList.add('hidden');
}

function saveSignature(){
  // grab a white background snapshot so the signature displays well in PDF
  const tmp = document.createElement('canvas');
  tmp.width = sigCanvas.width;
  tmp.height = sigCanvas.height;
  const tctx = tmp.getContext('2d');
  tctx.fillStyle = '#ffffff';
  tctx.fillRect(0,0,tmp.width,tmp.height);
  tctx.drawImage(sigCanvas, 0, 0);
  const data = tmp.toDataURL('image/png');
  $('firma_base64').value = data;
  // show thumbnail
  $('signature-thumb').src = data;
  $('signature-preview').classList.remove('hidden');
  $('signature-prompt-text').textContent = 'Firma capturada';
  closeSignatureModal();
}

/* ------------------------ Answer selection visuals ------------------------ */
function enhanceAnswerButtons(){
  // add click handler on answer labels to toggle selected styles
  document.querySelectorAll('.answer-btn').forEach(lbl=>{
    lbl.addEventListener('click', (e)=>{
      // find input inside
      const inp = lbl.querySelector('input');
      if(!inp) return;
      // mark the radio (works even if hidden)
      inp.checked = true;
      // clear siblings of same name
      const name = inp.name;
      document.querySelectorAll(`input[name="${name}"]`).forEach(r=>{
        if(r !== inp && r.parentElement) r.parentElement.classList.remove('btn-selected','dark');
      });
      // apply selected style
      lbl.classList.add('btn-selected','dark');
    });
  });
}
enhanceAnswerButtons();

/* ------------------------ Toggle recuadro 1.3 ------------------------ */
function toggleQ13(){
  const op = document.querySelector('input[name="q13"]:checked');
  const box = $('q13_box');
  if(op && op.value === 'si'){
    box.classList.remove('hidden');
    $('q13_text').focus();
  } else {
    box.classList.add('hidden');
    $('q13_text').value = '';
  }
}

/* ------------------------ Validation logic ------------------------ */
function validateAllBeforePreview(){
  // required text fields
  const required = ['empresa','supervisor','area','lugar_especifico','fecha','hora_inicio','hora_termino','descripcion'];
  for(const id of required){
    const v = $(id).value || '';
    if(!v.trim()){
      alert('Complete el campo: ' + id.toUpperCase());
      return false;
    }
  }

  // check 1.2 radios are all answered
  const q12 = ['q12_1','q12_2','q12_3'];
  for(const name of q12){
    if(!document.querySelector(`input[name="${name}"]:checked`)){
      alert('Debe responder todas las preguntas en 1.2');
      return false;
    }
    // if any is 'no' block (user wanted 'No' to alert)
    const val = document.querySelector(`input[name="${name}"]:checked`).value;
    if(val === 'no'){
      alert('Hay una respuesta "No" en 1.2 ‚Äî NO INICIAR LA TAREA.');
      return false;
    }
  }

  // 1.3 capacitado_prevencion must be yes
  const cap = document.querySelector('input[name="q13_cap"]:checked');
  if(!cap){ alert('Responda si est√° capacitado en 1.3.1'); return false; }
  if(cap.value === 'no'){ alert('Respuesta "No" en 1.3.1 ‚Äî NO INICIAR LA TAREA.'); return false; }

  // 1.3 document regulation
  const q13 = document.querySelector('input[name="q13"]:checked');
  if(!q13){ alert('Responda la pregunta sobre documento regulador (1.3.2)'); return false; }
  if(q13.value === 'si'){
    const txt = $('q13_text').value.trim();
    if(!txt){ alert('Si respondi√≥ "S√≠" en 1.3.2, indique el documento en el recuadro.'); return false; }
  }

  // signature required (but we can allow user to confirm if missing)
  if(!$('firma_base64').value){
    if(!confirm('No ha firmado a√∫n. ¬øDesea continuar sin firmar?')) return false;
  }

  return true;
}

/* ------------------------ Build PDF HTML (A4 template) ------------------------ */
function buildPDFHtml(){
  const antecedentes = {
    empresa: $('empresa').value || '',
    supervisor: $('supervisor').value || '',
    area: $('area').value || '',
    lugar_especifico: $('lugar_especifico').value || '',
    fecha: $('fecha').value || '',
    hora_inicio: $('hora_inicio').value || '',
    hora_termino: $('hora_termino').value || '',
    descripcion: $('descripcion').value || '',
    firma: $('firma_base64').value || ''
  };

  function ans(name){ const r = document.querySelector(`input[name="${name}"]:checked`); return r ? r.value : '(no indicado)'; }

  const q13doc = ans('q13') === 'si' ? $('q13_text').value.trim() : '';

  // Return sanitized HTML for PDF
  return `
  <div class="pdf-page" style="font-family:Inter,Arial,Helvetica,sans-serif;color:#111827;">
    <div style="display:flex;justify-content:space-between;align-items:flex-start">
      <div>
        <div style="font-size:18px;font-weight:700;color:${'var(--accent-blue)'}">AN√ÅLISIS DE RIESGOS DE LA TAREA (ART)</div>
        <div style="font-size:11px;color:#6b7280;margin-top:6px;">Generado: ${new Date().toLocaleString()} - Usuario: ${userId}</div>
      </div>
      <div style="text-align:right;">
        <!-- simple logo circle -->
        <svg width="72" height="72" viewBox="0 0 72 72" xmlns="http://www.w3.org/2000/svg">
          <circle cx="36" cy="36" r="34" fill="#f3f4f6" stroke="#cbd5e1" stroke-width="2"/>
          <text x="36" y="40" font-size="9" font-family="Inter, sans-serif" font-weight="700" text-anchor="middle" fill="#374151">TU LOGO</text>
        </svg>
      </div>
    </div>

    <h3 style="margin-top:18px;color:#b91c1c;border-bottom:2px solid #ef4444;padding-bottom:6px;">I) ANTECEDENTES</h3>
    <div style="margin-top:8px;">
      <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #eef2f7;"><div style="width:40%;font-weight:700;color:#374151">Empresa</div><div style="width:60%;text-align:right">${antecedentes.empresa}</div></div>
      <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #eef2f7;"><div style="width:40%;font-weight:700;color:#374151">Supervisor</div><div style="width:60%;text-align:right">${antecedentes.supervisor}</div></div>
      <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #eef2f7;"><div style="width:40%;font-weight:700;color:#374151">√Årea</div><div style="width:60%;text-align:right">${antecedentes.area}</div></div>
      <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #eef2f7;"><div style="width:40%;font-weight:700;color:#374151">Lugar</div><div style="width:60%;text-align:right">${antecedentes.lugar_especifico}</div></div>
      <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #eef2f7;"><div style="width:40%;font-weight:700;color:#374151">Fecha</div><div style="width:60%;text-align:right">${antecedentes.fecha}</div></div>
      <div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #eef2f7;"><div style="width:40%;font-weight:700;color:#374151">Horario</div><div style="width:60%;text-align:right">${antecedentes.hora_inicio} - ${antecedentes.hora_termino}</div></div>
    </div>

    <div style="margin-top:12px;">
      <div style="font-weight:700">Descripci√≥n</div>
      <div style="border:1px solid #eef2f7;padding:8px;margin-top:6px;background:#f8fafc">${antecedentes.descripcion}</div>
    </div>

    <div style="margin-top:12px;">
      <div style="font-weight:700">Firma del supervisor</div>
      <div style="border:1px solid #1f2937;padding:8px;margin-top:6px;height:100px;display:flex;align-items:center;justify-content:center;background:#fff;">
        ${antecedentes.firma ? `<img src="${antecedentes.firma}" style="max-width:100%;max-height:90px;object-fit:contain;" />` : '(sin firma)'}
      </div>
    </div>

    <h3 style="margin-top:18px;color:#b91c1c;border-bottom:2px solid #ef4444;padding-bottom:6px;">1.2) Riesgos generales</h3>
    <div style="margin-top:8px;">
      <div style="padding:6px 0;border-bottom:1px dashed #eef2f7;"><strong>Condiciones inseguras:</strong> ${(document.querySelector('input[name=\"q12_1\"]:checked')||{}).value || '(no indicado)'}</div>
      <div style="padding:6px 0;border-bottom:1px dashed #eef2f7;"><strong>Equipos en mal estado:</strong> ${(document.querySelector('input[name=\"q12_2\"]:checked')||{}).value || '(no indicado)'}</div>
      <div style="padding:6px 0;border-bottom:1px dashed #eef2f7;"><strong>Falta se√±alizaci√≥n:</strong> ${(document.querySelector('input[name=\"q12_3\"]:checked')||{}).value || '(no indicado)'}</div>
    </div>

    <h3 style="margin-top:18px;color:#0f4b8f;border-bottom:2px solid #0f4b8f;padding-bottom:6px;">1.3) De la tarea</h3>
    <div style="margin-top:8px;">
      <div style="padding:6px 0;border-bottom:1px dashed #eef2f7;"><strong>Capacitado:</strong> ${(document.querySelector('input[name=\"q13_cap\"]:checked')||{}).value || '(no indicado)'}</div>
      <div style="padding:6px 0;border-bottom:1px dashed #eef2f7;"><strong>Existe documento:</strong> ${(document.querySelector('input[name=\"q13\"]:checked')||{}).value || '(no indicado)'}</div>
      ${q13doc ? `<div style="padding:6px 0;border-bottom:1px dashed #eef2f7;"><strong>Documento:</strong> ${q13doc}</div>` : ''}
    </div>

    <h3 style="margin-top:18px;color:#0d9488;border-bottom:2px solid #0d9488;padding-bottom:6px;">1.4) Estrategias aplicadas</h3>
    <div style="margin-top:8px;">
      <ul>
        ${Array.from(document.querySelectorAll('.strategy-checkbox')).filter(cb => cb.checked).map(cb => `<li>${cb.getAttribute('data-strategy-name')}</li>`).join('') || '<li>No se seleccionaron estrategias</li>'}
      </ul>
    </div>

  </div>
  `;
}

/* ------------------------ Preview & PDF generation ------------------------ */

function openPreview(){
  if(!validateAllBeforePreview()) return;
  // build HTML and put into off-screen target
  const html = buildPDFHtml();
  const target = $('pdf-render-target');
  target.innerHTML = html;

  if(isMobile()){
    // generate image preview
    html2canvas(target, {scale: 2, useCORS: true, backgroundColor:'#ffffff'}).then(canvas => {
      const img = canvas.toDataURL('image/png');
      showMobilePreview(img);
    }).catch(err => { alert('Error generando preview m√≥vil: ' + (err.message || err)); });
  } else {
    // web: show HTML in modal with download button
    $('pdf-preview-content').innerHTML = target.innerHTML;
    $('pdf-filename-input').value = `ART_${new Date().toISOString().slice(0,10)}_${$('supervisor').value.replace(/\s+/g,'_').slice(0,30) || 'ART'}.pdf`;
    showPreviewModal();
  }
}

/* Mobile preview modal */
function showMobilePreview(imgData){
  // create a modal-like overlay with image and big download
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.style.zIndex = 1000;
  modal.innerHTML = `
    <div class="modal-inner" style="max-width:640px;">
      <div style="text-align:right;"><button onclick="this.closest('.modal').remove()" class="px-2 py-1 rounded bg-gray-100">Cerrar</button></div>
      <img src="${imgData}" style="width:100%; border-radius:8px; border:1px solid #e6e6e6;" />
      <div style="margin-top:12px;">
        <button id="mobile-download-now" class="w-full bg-green-600 text-white py-3 rounded-lg">üì• Descargar PDF</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
  // download callback
  modal.querySelector('#mobile-download-now').addEventListener('click', ()=>{
    // build pdf and download
    generatePDF();
    modal.remove();
  });
}

/* Desktop preview modal functions */
function showPreviewModal(){ $('pdf-preview-modal').classList.remove('hidden'); }
function closePreviewModal(){ $('pdf-preview-modal').classList.add('hidden'); }
function showHistoryModal(){ $('history-modal').classList.remove('hidden'); }
function closeHistoryModal(){ $('history-modal').classList.add('hidden'); }

/* Download PDF (common) */
function generatePDF(){
  // check signature confirm
  if(!$('firma_base64').value){
    if(!confirm('La firma no est√° capturada. ¬øDesea generar igual el PDF?')) return;
  }
  const target = $('pdf-render-target');
  // ensure target already has content
  if(!target.innerHTML || target.innerHTML.trim()==='') target.innerHTML = buildPDFHtml();

  const opt = {
    margin: 10,
    filename: ($('pdf-filename-input').value.trim() || `ART_${new Date().toISOString().slice(0,10)}.pdf`),
    image: { type: 'jpeg', quality: 1 },
    html2canvas: { scale: 2, useCORS: true, backgroundColor: '#ffffff' },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
    pagebreak: { mode: ['avoid-all','css','legacy'] }
  };

  // produce the PDF
  html2pdf().set(opt).from(target).save().then(()=>{
    alert('PDF generado correctamente.');
  }).catch(err => {
    alert('Error al generar PDF: ' + (err.message || err));
    console.error(err);
  });
}

/* ------------------------ History (localStorage simple) ------------------------ */
const ART_HISTORY_KEY = 'art_chequeos_history';
function saveToHistory(obj){
  const arr = JSON.parse(localStorage.getItem(ART_HISTORY_KEY) || '[]');
  arr.push(obj);
  localStorage.setItem(ART_HISTORY_KEY, JSON.stringify(arr));
}
function loadHistory(){
  const arr = JSON.parse(localStorage.getItem(ART_HISTORY_KEY) || '[]');
  const list = $('history-list');
  list.innerHTML = '';
  if(arr.length === 0){ list.innerHTML = '<p class="text-sm text-gray-500">No hay registros.</p>'; return; }
  arr.slice().reverse().forEach(item => {
    const el = document.createElement('div');
    el.className = 'p-3 border rounded mb-2';
    el.innerHTML = `<div><strong>${item.antecedentes?.empresa || 'Sin empresa'}</strong> ‚Äî ${new Date(item.timestamp).toLocaleString()}</div><div class="mt-1 text-sm text-gray-500">${item.antecedentes?.area || ''}</div>`;
    list.appendChild(el);
  });
}

/* ------------------------ Utilities ------------------------ */
/* toggle Q13 when loaded (in case preselected) */
function restoreStateUI(){
  // apply selected classes to any checked radios (for direct load)
  document.querySelectorAll('input[type="radio"]').forEach(r=>{
    if(r.checked && r.parentElement) r.parentElement.classList.add('btn-selected','dark');
  });
  toggleQ13();
}
restoreStateUI();

/* attach events on dynamic buttons */
$('preview-art-btn').addEventListener('click', openPreview);
$('download-pdf-btn').addEventListener('click', generatePDF);
$('load-history-btn').addEventListener('click', ()=>{ loadHistory(); showHistoryModal(); });

/* init signature canvas */
initSignatureCanvas();

/* ensure pdf container exists */
if(!$('pdf-render-target')) {
  const d = document.createElement('div');
  d.id='pdf-render-target';
  d.style.position='fixed'; d.style.left='-9999px'; d.style.top='0';
  d.style.width='794px'; d.style.minHeight='1123px';
  document.body.appendChild(d);
}

/* prevent forms / default button submits (no real forms used, but to be safe) */
document.addEventListener('submit', e => e.preventDefault());

/* Final helper: ensure time spacing recalculation on resize */
window.addEventListener('resize', () => {
  document.querySelectorAll('.time-row').forEach(row=>{
    row.style.gap = window.innerWidth < 768 ? '1.5rem' : '2rem';
  });
});

</script>
</body>
</html>
