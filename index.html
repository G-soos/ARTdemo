<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ART - Análisis de Riesgos de la Tarea</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- html2pdf -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        body {
            background: #f5f5f5;
        }

        /* Página A4 rígida */
        .pdf-page {
            width: 794px;
            min-height: 1123px;
            padding: 32px;
            background: white;
            margin: 0 auto;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.15);
            position: relative;
        }

        .logo {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 100px;
            height: 100px;
        }

        .section-title {
            background: #e11d48;
            color: white;
            padding: 6px 12px;
            font-weight: bold;
            margin-top: 24px;
            margin-bottom: 8px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 16px;
        }

        .table td,
        .table th {
            border: 1px solid #d1d5db;
            padding: 6px 8px;
        }

        .wizard-step {
            display: none;
        }

        .wizard-step.active {
            display: block;
        }

        /* Ocultar scrollbar */
        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }

        /* Firma */
        .signature-box {
            width: 100%;
            height: 180px;
            border: 1px dashed #666;
            display: flex;
            justify-content: center;
            align-items: center;
        }
    </style>
</head>

<body class="p-4">
    <div id="mainContainer" class="max-w-3xl mx-auto">

        <h1 class="text-2xl font-bold mb-4 text-center">Análisis de Riesgos de la Tarea (ART)</h1>

        <!-- FORMULARIO (ESCRITORIO) -->
        <form id="formDesktop" class="space-y-6 hidden">

            <!-- 1.1 ANTECEDENTES -->
            <div class="bg-white p-5 shadow rounded-lg space-y-4">

                <h2 class="text-lg font-bold text-red-600">1.1 Antecedentes del Trabajo</h2>

                <input id="empresa" type="text" placeholder="Empresa"
                    class="w-full border p-3 rounded-lg">

                <input id="supervisor" type="text" placeholder="Supervisor"
                    class="w-full border p-3 rounded-lg">

                <input id="area" type="text" placeholder="Área"
                    class="w-full border p-3 rounded-lg">

                <input id="lugar_especifico" type="text" placeholder="Lugar Específico"
                    class="w-full border p-3 rounded-lg">

                <!-- FECHA / HORA (con títulos nuevos) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                    <div>
                        <label for="fecha" class="block text-sm font-semibold mb-1 text-gray-600">FECHA</label>
                        <input id="fecha" type="date"
                            class="w-full border p-3 rounded-lg">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold mb-1 text-gray-600">HORARIO</label>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="hora_inicio" class="text-xs text-gray-500">Hora Inicio</label>
                                <input id="hora_inicio" type="time"
                                    class="w-full border p-3 rounded-lg">
                            </div>
                            <div>
                                <label for="hora_termino" class="text-xs text-gray-500">Hora Término</label>
                                <input id="hora_termino" type="time"
                                    class="w-full border p-3 rounded-lg">
                            </div>
                        </div>
                    </div>

                </div>

                <textarea id="descripcion" placeholder="Descripción general del trabajo"
                    class="w-full border p-3 rounded-lg"></textarea>

            </div>
            <!-- 1.2 CHEQUEO DE SEGURIDAD -->
            <div class="bg-white p-5 shadow rounded-lg space-y-4">

                <h2 class="text-lg font-bold text-red-600">1.2 Chequeo de Seguridad</h2>

                <div id="checklist_12_desktop"></div>

            </div>

            <!-- 1.3 IDENTIFICACIÓN DE PELIGROS -->
            <div class="bg-white p-5 shadow rounded-lg space-y-4">

                <h2 class="text-lg font-bold text-red-600">1.3 Identificación de Peligros</h2>

                <div id="checklist_13_desktop"></div>

            </div>

            <!-- 1.4 ESTRATEGIAS DE CONTROL -->
            <div class="bg-white p-5 shadow rounded-lg space-y-4">

                <h2 class="text-lg font-bold text-red-600">1.4 Estrategias de Control</h2>

                <textarea id="estrategias" class="w-full border p-3 rounded-lg"
                    placeholder="Describa las estrategias de control"></textarea>

            </div>

            <!-- FIRMA -->
            <div class="bg-white p-5 shadow rounded-lg space-y-4">

                <h2 class="text-lg font-bold text-red-600">Firma del Supervisor</h2>

                <canvas id="signaturePad" class="border w-full h-48 rounded-lg"></canvas>

                <button type="button" id="clearSignature"
                    class="px-4 py-2 bg-gray-300 rounded-lg">Borrar Firma</button>

            </div>

            <button type="button" id="previewBtn"
                class="w-full bg-blue-600 text-white p-3 rounded-lg">PREVISUALIZAR</button>

        </form>

        <!-- FORMULARIO MÓVIL (WIZARD) -->
        <form id="formMobile" class="space-y-6 hidden">

            <div id="wizardSteps">

                <!-- Paso 1 -->
                <div class="wizard-step active" data-step="0">
                    <h2 class="text-lg font-bold text-red-600 mb-3">1.1 Antecedentes del Trabajo</h2>

                    <input id="empresa_m" type="text" placeholder="Empresa"
                        class="w-full border p-3 rounded-lg mb-3">

                    <input id="supervisor_m" type="text" placeholder="Supervisor"
                        class="w-full border p-3 rounded-lg mb-3">

                    <input id="area_m" type="text" placeholder="Área"
                        class="w-full border p-3 rounded-lg mb-3">

                    <input id="lugar_especifico_m" type="text" placeholder="Lugar Específico"
                        class="w-full border p-3 rounded-lg mb-3">

                    <label class="block text-sm font-semibold mb-1">FECHA</label>
                    <input id="fecha_m" type="date"
                        class="w-full border p-3 rounded-lg mb-3">

                    <label class="block text-sm font-semibold mb-1">HORARIO</label>
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="text-xs text-gray-500">Inicio</label>
                            <input id="hora_inicio_m" type="time"
                                class="w-full border p-3 rounded-lg">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500">Término</label>
                            <input id="hora_termino_m" type="time"
                                class="w-full border p-3 rounded-lg">
                        </div>
                    </div>

                    <textarea id="descripcion_m" placeholder="Descripción general del trabajo"
                        class="w-full border p-3 rounded-lg mb-6"></textarea>

                </div>

                <!-- Paso 2 -->
                <div class="wizard-step" data-step="1">
                    <h2 class="text-lg font-bold text-red-600 mb-3">1.2 Chequeo de Seguridad</h2>
                    <div id="checklist_12_mobile"></div>
                </div>

                <!-- Paso 3 -->
                <div class="wizard-step" data-step="2">
                    <h2 class="text-lg font-bold text-red-600 mb-3">1.3 Identificación de Peligros</h2>
                    <div id="checklist_13_mobile"></div>
                </div>

                <!-- Paso 4 -->
                <div class="wizard-step" data-step="3">
                    <h2 class="text-lg font-bold text-red-600 mb-3">1.4 Estrategias de Control</h2>
                    <textarea id="estrategias_m" class="w-full border p-3 rounded-lg"
                        placeholder="Describa las estrategias de control"></textarea>
                </div>

                <!-- Paso 5 -->
                <div class="wizard-step" data-step="4">
                    <h2 class="text-lg font-bold text-red-600 mb-3">Firma del Supervisor</h2>

                    <canvas id="signaturePad_m" class="border w-full h-48 rounded-lg"></canvas>

                    <button type="button" id="clearSignature_m"
                        class="px-4 py-2 bg-gray-300 rounded-lg mt-3">Borrar Firma</button>

                </div>

            </div>

            <!-- Navegación del wizard -->
            <div class="flex justify-between mt-4">
                <button type="button" id="wizardPrev"
                    class="px-4 py-2 bg-gray-300 rounded-lg">Anterior</button>

                <button type="button" id="wizardNext"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg">Siguiente</button>
            </div>

        </form>

        <!-- MODAL PREVIEW -->
        <div id="previewModal"
            class="fixed inset-0 bg-black bg-opacity-60 hidden justify-center items-center p-4">

            <div class="bg-white p-4 rounded-lg max-h-screen overflow-y-auto">

                <div id="previewContent"></div>

                <div class="flex justify-end gap-4 mt-4">
                    <button id="downloadPdfBtn"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg">DESCARGAR PDF</button>

                    <button id="closePreview"
                        class="px-4 py-2 bg-gray-400 rounded-lg">CERRAR</button>
                </div>

            </div>

        </div>

    </div> <!-- MAIN CONTAINER -->
<script>
/* ---------------------------------------------------
   VARIABLES GLOBALES
--------------------------------------------------- */
let isMobileMode = false;
let wizardStep = 0;
let wizardInitialized = false;

/* ---------------------------------------------------
   CHECKLIST DATA (12 & 13)
--------------------------------------------------- */
const checklist_12 = [
    "Se cuenta con los permisos de trabajo correspondientes",
    "Se verificó el estado de las herramientas",
    "Se inspeccionó el área de trabajo",
    "Se verificó el uso correcto de EPP",
    "La zona se encuentra delimitada",
];

const checklist_13 = [
    "Golpeado por objetos",
    "Caída a distinto nivel",
    "Contacto eléctrico",
    "Exposición a sustancias peligrosas",
    "Atrapamiento",
];

/* ---------------------------------------------------
   GENERAR CHECKLIST DESKTOP & MOBILE
--------------------------------------------------- */
function buildChecklist(containerId, items, prefix) {
    const cont = document.getElementById(containerId);
    cont.innerHTML = "";

    items.forEach((txt, i) => {
        cont.innerHTML += `
            <label class="flex items-center gap-2 mb-2">
                <input id="${prefix}${i}" type="checkbox" class="w-5 h-5">
                <span>${txt}</span>
            </label>
        `;
    });
}

/* ---------------------------------------------------
   PREPARAR WIZARD (solo 1 vez)
--------------------------------------------------- */
function prepareWizard() {
    if (wizardInitialized) return;
    wizardInitialized = true;

    // Copiar valores de escritorio a móvil
    const ids = [
        "empresa", "supervisor", "area", "lugar_especifico", "fecha",
        "hora_inicio", "hora_termino", "descripcion", "estrategias"
    ];

    ids.forEach(id => {
        const d = document.getElementById(id);
        const m = document.getElementById(id + "_m");
        if (d && m) m.value = d.value;
    });

    wizardStep = 0;
    updateWizardUI();
}

/* ---------------------------------------------------
   ACTUALIZAR PASOS DEL WIZARD
--------------------------------------------------- */
function updateWizardUI() {
    document.querySelectorAll(".wizard-step").forEach(step => {
        step.classList.remove("active");
    });

    const active = document.querySelector(`.wizard-step[data-step="${wizardStep}"]`);
    if (active) active.classList.add("active");

    document.getElementById("wizardPrev").style.display = wizardStep === 0 ? "none" : "block";
    document.getElementById("wizardNext").innerText = wizardStep === 4 ? "Finalizar" : "Siguiente";
}

/* ---------------------------------------------------
   CAMBIAR ENTRE DESKTOP Y MOBILE
--------------------------------------------------- */
function applyMode() {
    if (window.innerWidth < 768) {
        isMobileMode = true;
        document.getElementById("formDesktop").classList.add("hidden");
        document.getElementById("formMobile").classList.remove("hidden");

        prepareWizard();

    } else {
        isMobileMode = false;
        document.getElementById("formDesktop").classList.remove("hidden");
        document.getElementById("formMobile").classList.add("hidden");
    }
}

/* ---------------------------------------------------
   CONTROLAR RESIZE (sin borrar inputs en móvil)
--------------------------------------------------- */
let lastWidth = window.innerWidth;

function handleResize() {
    const currentWidth = window.innerWidth;

    if ((currentWidth < 768 && lastWidth >= 768) ||
        (currentWidth >= 768 && lastWidth < 768)) {

        applyMode();
    }

    lastWidth = currentWidth;
}

window.addEventListener("resize", handleResize);

/* ---------------------------------------------------
   COPIAR DATOS DE MOBILE → DESKTOP
--------------------------------------------------- */
function syncMobileToDesktop() {
    const ids = [
        "empresa", "supervisor", "area", "lugar_especifico", "fecha",
        "hora_inicio", "hora_termino", "descripcion", "estrategias"
    ];

    ids.forEach(id => {
        const m = document.getElementById(id + "_m");
        const d = document.getElementById(id);
        if (m && d) d.value = m.value;
    });

    // Copiar checks
    checklist_12.forEach((_, i) => {
        document.getElementById("12_" + i).checked =
            document.getElementById("12_" + i + "_m").checked;
    });

    checklist_13.forEach((_, i) => {
        document.getElementById("13_" + i).checked =
            document.getElementById("13_" + i + "_m").checked;
    });
}

/* ---------------------------------------------------
   PREVIEW (MOSTRAR MODAL)
--------------------------------------------------- */
document.getElementById("previewBtn")?.addEventListener("click", showPreview);

document.getElementById("wizardNext").addEventListener("click", () => {
    if (wizardStep < 4) {
        wizardStep++;
        updateWizardUI();
    } else {
        syncMobileToDesktop();
        showPreview();
    }
});

document.getElementById("wizardPrev").addEventListener("click", () => {
    if (wizardStep > 0) {
        wizardStep--;
        updateWizardUI();
    }
});

/* ---------------------------------------------------
   FUNCIÓN: MOSTRAR PREVIEW
--------------------------------------------------- */
function showPreview() {
    syncMobileToDesktop();

    const preview = document.getElementById("previewContent");
    preview.innerHTML = generatePdfHtml();

    document.getElementById("previewModal").classList.remove("hidden");
}

/* ---------------------------------------------------
   GENERAR HTML DEL PDF (A4)
--------------------------------------------------- */
function generatePdfHtml() {
    return `
        <div class="pdf-page">

            <svg class="logo" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="45" stroke="#666" stroke-width="2" fill="none"/>
                <text x="50%" y="54%" text-anchor="middle" fill="#666" font-size="10">TU LOGO AQUÍ</text>
            </svg>

            <h1 class="text-xl font-bold mb-4">Análisis de Riesgos de la Tarea (ART)</h1>

            <div class="section-title">1.1 Antecedentes del Trabajo</div>

            <table class="table">
                <tr><td>Empresa</td><td>${empresa.value}</td></tr>
                <tr><td>Supervisor</td><td>${supervisor.value}</td></tr>
                <tr><td>Área</td><td>${area.value}</td></tr>
                <tr><td>Lugar</td><td>${lugar_especifico.value}</td></tr>
                <tr><td>Fecha</td><td>${fecha.value}</td></tr>
                <tr><td>Horario</td><td>${hora_inicio.value} - ${hora_termino.value}</td></tr>
                <tr><td>Descripción</td><td>${descripcion.value}</td></tr>
            </table>

            <div class="section-title">1.2 Chequeo de Seguridad</div>

            <table class="table">
                ${checklist_12.map((txt, i) => `
                    <tr>
                        <td>${txt}</td>
                        <td>${document.getElementById("12_" + i).checked ? "✔" : ""}</td>
                    </tr>
                `).join("")}
            </table>

            <div class="section-title">1.3 Identificación de Peligros</div>

            <table class="table">
                ${checklist_13.map((txt, i) => `
                    <tr>
                        <td>${txt}</td>
                        <td>${document.getElementById("13_" + i).checked ? "✔" : ""}</td>
                    </tr>
                `).join("")}
            </table>

            <div class="section-title">1.4 Estrategias de Control</div>

            <p>${estrategias.value}</p>

            <div class="section-title">Firma del Supervisor</div>

            <div class="signature-box">
                <img src="${signaturePad.toDataURL()}" class="h-full object-contain">
            </div>

        </div>
    `;
}

/* ---------------------------------------------------
   DESCARGAR PDF
--------------------------------------------------- */
document.getElementById("downloadPdfBtn").addEventListener("click", async () => {

    let defaultName =
        `ART_${fecha.value}_${supervisor.value}`.replace(/\s+/g, "_");

    let custom = prompt("Nombre del archivo PDF:", defaultName);
    if (!custom) custom = defaultName;

    const element = document.getElementById("previewContent");

    const opt = {
        margin: 0,
        filename: custom + ".pdf",
        html2canvas: { scale: 2 },
        jsPDF: { unit: "px", format: "a4", orientation: "portrait" }
    };

    await html2pdf().set(opt).from(element).save();
});

/* ---------------------------------------------------
   CERRAR PREVIEW
--------------------------------------------------- */
document.getElementById("closePreview").addEventListener("click", () => {
    document.getElementById("previewModal").classList.add("hidden");
});

/* ---------------------------------------------------
   FIRMAS (desktop & mobile)
--------------------------------------------------- */
function initSignature(canvasId, clearBtnId) {
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext("2d");

    let drawing = false;

    canvas.addEventListener("mousedown", () => drawing = true);
    canvas.addEventListener("mouseup", () => drawing = false);
    canvas.addEventListener("mousemove", draw);

    canvas.addEventListener("touchstart", () => drawing = true);
    canvas.addEventListener("touchend", () => drawing = false);
    canvas.addEventListener("touchmove", draw);

    document.getElementById(clearBtnId).addEventListener("click", () => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    });

    function draw(e) {
        if (!drawing) return;

        const rect = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;

        ctx.fillRect(x, y, 2, 2);
    }

    return canvas;
}

const signaturePad = initSignature("signaturePad", "clearSignature");
const signaturePad_m = initSignature("signaturePad_m", "clearSignature_m");

/* ---------------------------------------------------
   INICIO
--------------------------------------------------- */
buildChecklist("checklist_12_desktop", checklist_12, "12_");
buildChecklist("checklist_13_desktop", checklist_13, "13_");

buildChecklist("checklist_12_mobile", checklist_12, "12_");
buildChecklist("checklist_13_mobile", checklist_13, "13_");

applyMode();

</script>

</body>
</html>
