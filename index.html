<!-- ART_final.html — PARTE 2 -->
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ART - PARTE 2 (HEAD + ESTILOS)</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Librerías para PDF / canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root{ --bg:#f7f7f9; --accent-red:#ef4444; --accent-blue:#0f4b8f; --accent-teal:#0d9488; }
    html,body{height:100%;}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial; background:var(--bg); color:#0f172a;}

    /* PDF page (A4) */
    .pdf-page{ width:794px; min-height:1123px; background:#fff; margin:0 auto; padding:28px; box-sizing:border-box; }

    /* Form layout */
    .field { display:block; width:100%; }

    /* Selected state (desktop): darker background + outline */
    .btn-selected{ box-shadow:0 0 0 3px rgba(15,75,143,0.12) inset; transform:translateY(-1px); }
    .btn-selected.dark{ background-color:#0f4b8f !important; color:white !important; }

    /* Make the selected button clearly framed (alternative) */
    .btn-outline-selected{ border:2px solid rgba(15,75,143,0.18); }

    /* Time inputs spacing (desktop + mobile) */
    .time-row{ display:grid; grid-template-columns:1fr 1fr; gap:1rem; }
    @media (min-width:1024px){ .time-row{ gap:2rem; } }

    /* Signature box hint */
    .sig-hint{ display:flex; align-items:center; gap:8px; justify-content:center; padding:8px; border-radius:8px; border:2px dashed #94a3b8; background:#f8fafc; color:#475569; }

    /* Mobile big download button placeholder (hidden on desktop) */
    #mobile-download-btn{ display:none; }
    @media (max-width:767px){ #mobile-download-btn{ display:inline-block; } }

    /* Wizard steps visual */
    .wizard-step{ display:none; }
    .wizard-step.active{ display:block; }

    /* Modal base */
    .modal { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(15,23,42,0.6); z-index:60; }

    /* Improve small screens form behaviour */
    input, textarea, select { font-family:inherit; }

    /* Make desktop radio-like buttons larger on selection */
    .answer-btn-1-2, .answer-btn-1-3 { min-width:72px; }

    /* Accessibility focus styles */
    .focus-ring:focus{ outline:3px solid rgba(13,148,136,0.15); outline-offset:2px; }

  </style>
</head>
<body class="min-h-screen">
  <div id="app-shell" class="max-w-4xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-2xl font-bold text-gray-800">ART — Análisis de Riesgos de la Tarea</h1>
      <p class="text-sm text-gray-500">PARTE 2: HEAD y estilos básicos. Pide PARTE 3 cuando quieras.</p>
    </header>

    <!-- Empezamos el form (PARTE 2 entrega el inicio de body + estructura) -->
    <main id="form-root">
      <section id="etapa1">
        <div class="bg-white p-4 rounded-lg shadow-sm">
          <h2 class="font-semibold text-lg text-red-600">I) ETAPA 1 — ANTECEDENTES</h2>
          <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
            <input id="empresa" class="field p-3 border rounded focus:ring focus:ring-red-200" placeholder="NOMBRE DE LA EMPRESA">
            <input id="supervisor" class="field p-3 border rounded" placeholder="NOMBRE DEL SUPERVISOR">
            <input id="area" class="field p-3 border rounded" placeholder="ÁREA DE TRABAJO">
            <input id="lugar_especifico" class="field p-3 border rounded" placeholder="LUGAR ESPECÍFICO">

            <div>
              <label class="block text-sm font-semibold mb-1">FECHA</label>
              <input id="fecha" type="date" class="p-3 border rounded w-full">
            </div>

            <div>
              <label class="block text-sm font-semibold mb-1">HORARIO</label>
              <div class="time-row">
                <div>
                  <label class="text-xs text-gray-500">Hora inicio</label>
                  <input id="hora_inicio" type="time" class="p-3 border rounded w-full">
                </div>
                <div>
                  <label class="text-xs text-gray-500">Hora término</label>
                  <input id="hora_termino" type="time" class="p-3 border rounded w-full">
                </div>
              </div>
            </div>

            <div class="md:col-span-2">
              <label class="block text-sm font-semibold mb-1">DESCRIPCIÓN</label>
              <textarea id="descripcion" rows="3" class="p-3 border rounded w-full"></textarea>
            </div>

            <div class="md:col-span-2">
              <label class="block text-sm font-semibold mb-1">FIRMA</label>
              <div id="signature-prompt" class="sig-hint cursor-pointer" role="button" tabindex="0" onclick="openSignatureModal()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0-2 1-4 3-4s3 2 3 4-1 4-3 4-3-2-3-4z"/></svg>
                <span id="signature-prompt-text" class="text-sm text-gray-600">Toca para firmar — (móvil: girar a horizontal)</span>
              </div>
              <input type="hidden" id="firma_base64">
            </div>

          </div>
        </div>
      </section>

      <!-- footer actions (sent here for PARTE 2) -->
      <div class="mt-6 flex items-center justify-between">
        <div class="text-sm text-gray-500">ID local: <span id="user-id" class="font-mono">---</span></div>
        <div class="flex items-center gap-3">
          <button id="preview-art-btn" class="bg-blue-600 text-white px-4 py-2 rounded">Previsualizar</button>
          <button id="load-history-btn" class="bg-gray-200 px-3 py-2 rounded">Historial</button>
        </div>
      </div>

    </main>
  </div>

  <script>
    // PARTE 2: ligero script para inicializar ID local y evitar PDF en blanco por contenedor faltante
    document.addEventListener('DOMContentLoaded', ()=>{
      const userId = 'Local-' + Math.random().toString(16).slice(2,8);
      document.getElementById('user-id').textContent = userId;

      // Ensure a stable PDF container exists to avoid html2pdf producing blank pages
      if(!document.getElementById('pdf-render-target')){
        const d=document.createElement('div'); d.id='pdf-render-target'; d.style.position='fixed'; d.style.left='-9999px'; d.style.top='0'; d.style.width='794px'; d.style.minHeight='1123px'; d.style.boxSizing='border-box'; document.body.appendChild(d);
      }

    });
  </script>
</body>
  
<!-- === PARTE 3 — MODAL DE FIRMA COMPLETA === -->
<div id="signature-modal" class="modal hidden">
  <div class="bg-white rounded-lg p-4 w-full max-w-3xl flex flex-col gap-4 relative">

    <h2 class="text-lg font-bold text-gray-800 text-center">Firma del trabajador</h2>
    <p class="text-sm text-gray-500 text-center">Gira tu teléfono horizontalmente para una mejor experiencia</p>

    <!-- Área de firma -->
    <div class="w-full flex justify-center">
      <canvas id="signature-canvas" width="900" height="450" class="border border-gray-300 rounded shadow"></canvas>
    </div>

    <!-- Botones -->
    <div class="flex justify-between mt-2">
      <button onclick="clearSignature()" class="px-4 py-2 bg-gray-200 rounded">Borrar</button>
      <button onclick="closeSignatureModal()" class="px-4 py-2 bg-blue-600 text-white rounded">Aceptar firma</button>
    </div>

  </div>
</div>

<script>
// === PARTE 3 — FIRMA ===
let canvas, ctx, drawing = false, rect;

function openSignatureModal(){
  const modal = document.getElementById('signature-modal');
  modal.classList.remove('hidden');
  setTimeout(initSignatureCanvas, 50);
}

function closeSignatureModal(){
  const modal = document.getElementById('signature-modal');
  modal.classList.add('hidden');
  saveSignature();
}

function initSignatureCanvas(){
  canvas = document.getElementById('signature-canvas');
  ctx = canvas.getContext('2d');
  rect = canvas.getBoundingClientRect();

  ctx.lineWidth = 3;
  ctx.lineCap = 'round';
  ctx.strokeStyle = '#000';

  canvas.addEventListener('touchstart', startDraw);
  canvas.addEventListener('touchmove', draw);
  canvas.addEventListener('touchend', stopDraw);
  canvas.addEventListener('mousedown', startDraw);
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('mouseup', stopDraw);
}

function startDraw(e){
  e.preventDefault();
  drawing = true;
  const pos = getPos(e);
  ctx.beginPath();
  ctx.moveTo(pos.x, pos.y);
}
function draw(e){
  if(!drawing) return;
  const pos = getPos(e);
  ctx.lineTo(pos.x, pos.y);
  ctx.stroke();
}
function stopDraw(){ drawing = false; }

function getPos(e){
  const touch = e.touches ? e.touches[0] : e;
  return {
    x: touch.clientX - rect.left,
    y: touch.clientY - rect.top
  };
}

function clearSignature(){ ctx.clearRect(0,0,canvas.width,canvas.height); }

function saveSignature(){
  const base64 = canvas.toDataURL();
  document.getElementById('firma_base64').value = base64;
  document.getElementById('signature-prompt-text').textContent = "Firma capturada";
}
</script>


<!-- === PARTE 4 — WIZARD + VALIDACIONES + RECUADROS === -->
<script>
// ==========================
// WIZARD MOBILE / DESKTOP
// ==========================
let currentStep = 1;

function showStep(n){
  document.querySelectorAll('.wizard-step').forEach(s => s.classList.remove('active'));
  const step = document.getElementById('step-'+n);
  if(step) step.classList.add('active');
  currentStep = n;
}

function nextStep(){
  if(!validateStep(currentStep)) return;
  showStep(currentStep+1);
}

function prevStep(){
  showStep(currentStep-1);
}

// ==========================
// VALIDACIONES DE "NO"
// ==========================
function validateStep(n){
  // Paso 1.2
  if(n === 2){
    const r1 = document.querySelector('input[name="q12_1"]:checked');
    const r2 = document.querySelector('input[name="q12_2"]:checked');
    const r3 = document.querySelector('input[name="q12_3"]:checked');
    if(!r1 || !r2 || !r3){ alert("Debe responder todas las preguntas."); return false; }
  }

  // Paso 1.3
  if(n === 3){
    const op = document.querySelector('input[name="q13"]:checked');
    if(!op){ alert("Debe responder Sí o No."); return false; }
    if(op.value === "si"){
      const txt = document.getElementById('q13_text').value.trim();
      if(!txt){ alert("Debe completar el recuadro."); return false; }
    }
  }

  return true;
}

// ==========================
// MOSTRAR / OCULTAR RECUADRO DE 1.3
// ==========================
function toggleQ13(){
  const op = document.querySelector('input[name="q13"]:checked');
  const box = document.getElementById('q13_box');
  if(op && op.value === "si") box.classList.remove('hidden');
  else box.classList.add('hidden');
}
</script>

<!-- === HTML WIZARD (AÑADIDO) === -->
<section id="wizard-wrapper" class="mt-10">
  <!-- PASO 1.2 -->
  <div id="step-2" class="wizard-step">
    <h3 class="text-lg font-semibold text-teal-700">1.2) Riesgos generales</h3>

    <!-- Preguntas Sí/No uniformadas -->
    <div class="mt-4">
      <p class="font-medium">¿Condiciones inseguras?</p>
      <div class="flex gap-3 mt-2">
        <label class="px-4 py-2 border rounded cursor-pointer answer-btn-1-2">
          <input type="radio" name="q12_1" value="si" class="hidden">Sí
        </label>
        <label class="px-4 py-2 border rounded cursor-pointer answer-btn-1-2">
          <input type="radio" name="q12_1" value="no" class="hidden">No
        </label>
      </div>
    </div>

    <div class="mt-4">
      <p class="font-medium">¿Equipos en mal estado?</p>
      <div class="flex gap-3 mt-2">
        <label class="px-4 py-2 border rounded cursor-pointer answer-btn-1-2">
          <input type="radio" name="q12_2" value="si" class="hidden">Sí
        </label>
        <label class="px-4 py-2 border rounded cursor-pointer answer-btn-1-2">
          <input type="radio" name="q12_2" value="no" class="hidden">No
        </label>
      </div>
    </div>

    <div class="mt-4">
      <p class="font-medium">¿Falta de señalización?</p>
      <div class="flex gap-3 mt-2">
        <label class="px-4 py-2 border rounded cursor-pointer answer-btn-1-2">
          <input type="radio" name="q12_3" value="si" class="hidden">Sí
        </label>
        <label class="px-4 py-2 border rounded cursor-pointer answer-btn-1-2">
          <input type="radio" name="q12_3" value="no" class="hidden">No
        </label>
      </div>
    </div>

    <div class="flex justify-between mt-6">
      <button onclick="prevStep()" class="px-4 py-2 bg-gray-200 rounded">Anterior</button>
      <button onclick="nextStep()" class="px-4 py-2 bg-blue-600 text-white rounded">Siguiente</button>
    </div>
  </div>

  <!-- PASO 1.3 -->
  <div id="step-3" class="wizard-step">
    <h3 class="text-lg font-semibold text-red-700">1.3) ¿Existe un documento que regule mi trabajo?</h3>

    <div class="flex gap-3 mt-4">
      <label class="px-4 py-2 border rounded cursor-pointer answer-btn-1-3">
        <input type="radio" name="q13" value="si" onchange="toggleQ13()" class="hidden">Sí
      </label>

      <label class="px-4 py-2 border rounded cursor-pointer answer-btn-1-3">
        <input type="radio" name="q13" value="no" onchange="toggleQ13()" class="hidden">No
      </label>
    </div>

    <div id="q13_box" class="hidden mt-4">
      <textarea id="q13_text" rows="3" class="w-full p-3 border rounded" placeholder="Especifique el documento..."></textarea>
    </div>

    <div class="flex justify-between mt-6">
      <button onclick="prevStep()" class="px-4 py-2 bg-gray-200 rounded">Anterior</button>
      <button onclick="nextStep()" class="px-4 py-2 bg-blue-600 text-white rounded">Siguiente</button>
    </div>
  </div>
</section>


<!-- === PARTE 5 — PREVIEW + PDF REAL SIN BLANCO + PREVIEW MÓVIL COMO IMAGEN === -->

<script>
// ===============================================
//   GENERAR HTML DEL PDF (PLANTILLA A4 REAL)
// ===============================================
function buildPDFHtml(){
  const firma = document.getElementById('firma_base64').value;

  return `
  <div class="pdf-page">
    <h1 style="font-size:20px; font-weight:700; color:#0f4b8f;">ANÁLISIS DE RIESGOS DE LA TAREA (ART)</h1>

    <h3 style="margin-top:20px; font-weight:600; color:#ef4444;">I) ANTECEDENTES</h3>
    <p><b>Empresa:</b> ${empresa.value}</p>
    <p><b>Supervisor:</b> ${supervisor.value}</p>
    <p><b>Área:</b> ${area.value}</p>
    <p><b>Lugar:</b> ${lugar_especifico.value}</p>
    <p><b>Fecha:</b> ${fecha.value}</p>
    <p><b>Hora inicio:</b> ${hora_inicio.value} — <b>Hora término:</b> ${hora_termino.value}</p>

    <p style="margin-top:15px;"><b>Descripción:</b><br>${descripcion.value}</p>

    <div style="margin-top:20px;">
      <b>Firma:</b><br>
      ${firma ? `<img src="${firma}" style="width:260px; height:auto; border:1px solid #ddd;">` : '(sin firma)'}
    </div>

    <h3 style="margin-top:30px; font-weight:600; color:#0d9488;">1.2) Riesgos generales</h3>
    <p><b>Condiciones inseguras:</b> ${getAnswerText('q12_1')}</p>
    <p><b>Equipos mal estado:</b> ${getAnswerText('q12_2')}</p>
    <p><b>Falta señalización:</b> ${getAnswerText('q12_3')}</p>

    <h3 style="margin-top:30px; font-weight:600; color:#7f1d1d;">1.3) Documento regulador</h3>
    <p><b>¿Existe documento?:</b> ${getAnswerText('q13')}</p>
    ${getAnswerText('q13') === 'si' ? `<p><b>Documento:</b> ${q13_text.value}</p>` : ''}
  </div>`;
}

function getAnswerText(name){
  const r = document.querySelector(`input[name="${name}"]:checked`);
  return r ? r.value : '(no indicado)';
}

// ===============================================
//  PREVIEW — DESKTOP = HTML, MÓVIL = IMAGEN PNG
// ===============================================
function openPreview(){
  const html = buildPDFHtml();
  const target = document.getElementById('pdf-render-target');
  target.innerHTML = html;

  if(isMobile()){
    generateMobilePreview();
  } else {
    generateDesktopPreview();
  }
}

function isMobile(){ return window.innerWidth < 768; }

// -------------------------
// PREVIEW DESKTOP (HTML)
// -------------------------
function generateDesktopPreview(){
  let w = window.open('', '_blank');
  w.document.write(`
    <html><head><title>Preview ART</title></head>
    <body style="margin:0; padding:0; background:#eee;">
      ${document.getElementById('pdf-render-target').innerHTML}
      <button onclick="window.parent.generatePDF()" style="position:fixed; bottom:20px; right:20px; padding:12px 20px; background:#0f4b8f; color:white; border:none; border-radius:8px;">Descargar PDF</button>
    </body>
<!-- === PARTE 6 — AJUSTES FINALES, LIMPIEZA, FIXES DE BOTONES SÍ/NO === -->
<script>
// ===============================================
// DESTACAR BOTONES SÍ / NO AL SELECCIONAR (WEB + MÓVIL)
// ===============================================
function enhanceRadioSelectors(){
  const groups = ["q12_1","q12_2","q12_3","q13"];

  groups.forEach(name=>{
    document.querySelectorAll(`input[name="${name}"]`).forEach(r=>{
      r.addEventListener('change', ()=>{
        document.querySelectorAll(`input[name="${name}"]`).forEach(x=>{
          x.parentElement.classList.remove('btn-selected','dark');
        });
        r.parentElement.classList.add('btn-selected','dark');
      });
    });
  });
}
enhanceRadioSelectors();

// ===============================================
// MOSTRAR AUTOMÁTICAMENTE EL PRIMER PASO DEL WIZARD EN MÓVIL
// ===============================================
if(window.innerWidth < 768){ showStep(2); }

// ===============================================
// SEPARACIÓN EXTRA PARA HORARIOS EN MÓVIL
// ===============================================
function fixTimeSpacing(){
  document.querySelectorAll('.time-row').forEach(row=>{
    row.style.gap = window.innerWidth < 768 ? '1.5rem' : '2rem';
  });
}
fixTimeSpacing();
window.addEventListener('resize', fixTimeSpacing);

// ===============================================
// EVITAR QUE EL PDF SE GENERE EN BLANCO AUNQUE EL USUARIO NO ESPERE
// ===============================================
function ensurePDFContainer(){
  const t=document.getElementById('pdf-render-target');
  if(!t){
    const d=document.createElement('div');
    d.id='pdf-render-target';
    d.style.position='fixed'; d.style.left='-9999px'; d.style.top='0';
    d.style.width='794px'; d.style.minHeight='1123px';
    document.body.appendChild(d);
  }
}
ensurePDFContainer();

// ===============================================
// SANITY CHECK: ADVERTIR SI FALTA LA FIRMA
// ===============================================
function checkSignatureBeforePDF(){
  if(!document.getElementById('firma_base64').value){
    return confirm("No ha firmado aún. ¿Desea generar el PDF igualmente?");
  }
  return true;
}

// Reemplazar generatePDF para incluir esta validación
const oldGeneratePDF = generatePDF;
generatePDF = function(){ if(checkSignatureBeforePDF()) oldGeneratePDF(); };
</script>

</html>`);
  w.document.close();
}

// -------------------------
// PREVIEW MÓVIL (IMAGEN)
// -------------------------
async function generateMobilePreview(){
  const target = document.getElementById('pdf-render-target');
  const canvas = await html2canvas(target, {scale:2});
  const img = canvas.toDataURL('image/png');

  showMobilePreview(img);
}

function showMobilePreview(img){
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.innerHTML = `
    <div class="bg-white p-4 rounded-lg max-w-lg w-full text-center">
      <img src="${img}" class="w-full rounded border" />
      <button onclick="generatePDF()" class="mt-4 w-full bg-teal-600 text-white py-3 rounded-lg">DESCARGAR PDF</button>
      <button onclick="this.parentElement.parentElement.remove()" class="mt-2 w-full bg-gray-200 py-2 rounded-lg">Cerrar</button>
    </div>`;

  document.body.appendChild(modal);
}

// ===============================================
//  GENERAR PDF FINAL (MÓVIL + WEB)
// ===============================================
function generatePDF(){
  const html = buildPDFHtml();
  const target = document.getElementById('pdf-render-target');
  target.innerHTML = html;

  const opt = {
    margin: 10,
    filename: `ART_${Date.now()}.pdf`,
    html2canvas: {scale:2},
    jsPDF: {unit:'pt', format:'a4', orientation:'portrait'}
  };

  html2pdf().set(opt).from(target).save();
}

// ===============================================
// BOTÓN DE PREVIEW PRINCIPAL
// ===============================================
document.getElementById('preview-art-btn').addEventListener('click', openPreview);
</script>

</html>
